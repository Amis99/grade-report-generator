<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>성적표 생성 프로그램</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/sheet-style.css">
    <link rel="stylesheet" href="css/auth-style.css">
</head>
<body>
    <div class="app-container">
        <!-- 헤더 -->
        <header class="app-header">
            <div class="header-logo">
                <img src="images/logo.png" alt="국어농장" class="logo-image">
                <h1>성적표 생성 프로그램</h1>
            </div>
            <div class="header-right">
                <div id="userInfoDisplay" class="user-info-header" style="display: none;">
                    <span class="user-name" id="headerUserName"></span>
                    <span class="user-org" id="headerUserOrg"></span>
                </div>
                <button id="hamburgerBtn" class="hamburger-btn" aria-label="메뉴">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                <div id="headerMenu" class="header-dropdown">
                    <button id="studentAccountBtn" class="dropdown-item" style="display: none;">
                        <span class="dropdown-icon">👥</span> 학생 계정 관리
                    </button>
                    <button id="adminMenuBtn" class="dropdown-item" style="display: none;">
                        <span class="dropdown-icon">⚙️</span> 관리자 메뉴 <span id="pendingCount" class="badge"></span>
                    </button>
                    <div class="dropdown-divider" id="menuDivider1" style="display: none;"></div>
                    <button id="exportDataBtn" class="dropdown-item">
                        <span class="dropdown-icon">💾</span> 데이터 백업
                    </button>
                    <button id="importDataBtn" class="dropdown-item">
                        <span class="dropdown-icon">📂</span> 데이터 복원
                    </button>
                    <div class="dropdown-divider"></div>
                    <button id="changePasswordBtn" class="dropdown-item" style="display: none;">
                        <span class="dropdown-icon">🔑</span> 비밀번호 변경
                    </button>
                    <button id="logoutBtn" class="dropdown-item dropdown-item-danger" style="display: none;">
                        <span class="dropdown-icon">🚪</span> 로그아웃
                    </button>
                </div>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="tab-navigation">
            <button class="tab-btn active" data-tab="exam-management">시험 관리</button>
            <button class="tab-btn" data-tab="student-management">학생 관리</button>
            <button class="tab-btn" data-tab="class-management">수강반 관리</button>
            <button class="tab-btn" data-tab="answer-input">답안 입력</button>
            <button class="tab-btn" data-tab="grading">채점 및 분석</button>
            <button class="tab-btn" data-tab="report">성적표 생성</button>
            <button class="tab-btn" data-tab="wrong-note">학생별 오답 노트</button>
        </nav>

        <!-- 메인 콘텐츠 -->
        <main class="main-content">
            <!-- 시험 관리 탭 -->
            <section id="exam-management" class="tab-content active">
                <div class="section-header">
                    <h2>시험 관리</h2>
                    <button id="createExamBtn" class="btn btn-primary">새 시험 만들기</button>
                </div>

                <div class="exam-list-container">
                    <h3>시험 목록</h3>
                    <div class="exam-list-filter">
                        <input type="text" id="examSearchInput" name="exam-filter" class="form-control" placeholder="시험명, 시행 기관, 학교, 학년으로 검색..." autocomplete="off">
                    </div>
                    <div id="examList" class="exam-list">
                        <!-- 시험 목록이 여기에 동적으로 추가됨 -->
                    </div>
                    <div id="examPagination" class="pagination">
                        <!-- 페이지네이션 버튼이 여기에 동적으로 추가됨 -->
                    </div>
                </div>

                <div id="examDetailSection" class="exam-detail-section" style="display: none;">
                    <div class="detail-header">
                        <h3>시험 및 문제 관리 (총 <span id="questionCount">0</span>문제, <span id="totalPoints">0</span>점)</h3>
                        <div class="detail-actions">
                            <button id="importQuestionsBtn" class="btn btn-secondary">CSV 가져오기</button>
                            <button id="exportQuestionsBtn" class="btn btn-secondary">CSV 내보내기</button>
                            <button id="deleteExamBtn" class="btn btn-danger">시험 삭제</button>
                        </div>
                    </div>

                    <div id="questionList" class="question-list">
                        <!-- 시험 정보 + 문제 시트가 여기에 동적으로 추가됨 -->
                    </div>
                </div>
            </section>

            <!-- 학생 관리 탭 -->
            <section id="student-management" class="tab-content">
                <div class="section-header">
                    <h2>학생 관리</h2>
                    <div class="header-actions">
                        <button id="detectDuplicatesBtn" class="btn btn-warning">중복 학생 찾기</button>
                        <button id="autoMergeBtn" class="btn btn-danger">모두 자동 병합</button>
                    </div>
                </div>

                <div class="student-management-container">
                    <!-- 중복 학생 안내 -->
                    <div id="duplicateAlert" class="alert alert-info" style="display: none;">
                        <strong>중복 학생 발견!</strong> 아래 학생들을 확인하고 병합하세요.
                    </div>

                    <!-- 중복 학생 목록 -->
                    <div id="duplicateStudentsSection" style="display: none;">
                        <h3>중복 가능성이 있는 학생</h3>
                        <div id="duplicateStudentsList" class="duplicate-students-list">
                            <!-- 중복 학생 그룹이 동적으로 추가됨 -->
                        </div>
                    </div>

                    <!-- 전체 학생 목록 -->
                    <div class="all-students-section">
                        <h3>전체 학생 목록</h3>
                        <div class="student-list-filter">
                            <div class="filter-row">
                                <label class="select-all-checkbox">
                                    <input type="checkbox" id="selectAllStudents" onchange="studentManager.toggleSelectAll(this.checked)">
                                    <span>전체 선택</span>
                                </label>
                                <input type="text" id="studentSearchInput" class="form-control" placeholder="학생 이름, 학교, 학년으로 검색...">
                                <select id="studentClassFilter" class="form-control">
                                    <option value="">모든 수강반</option>
                                </select>
                            </div>
                        </div>
                        <div id="studentList" class="student-list">
                            <!-- 학생 목록이 동적으로 추가됨 -->
                        </div>
                    </div>

                    <!-- 선택된 학생 액션 바 -->
                    <div id="studentSelectionBar" class="selection-action-bar" style="display: none;">
                        <span id="selectedStudentCount">0명 선택됨</span>
                        <div class="selection-actions">
                            <button class="btn btn-primary" onclick="studentManager.showAddToClassModal()">
                                수강반에 등록
                            </button>
                            <button class="btn btn-secondary" onclick="studentManager.clearSelection()">
                                선택 해제
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 수강반 등록 모달 -->
                <div id="addToClassModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>수강반에 학생 등록</h3>
                            <button class="modal-close" onclick="studentManager.closeAddToClassModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p id="addToClassInfo" style="margin-bottom: 1rem; color: var(--text-secondary);">
                                선택된 학생 0명을 등록할 수강반을 선택하세요.
                            </p>
                            <div class="form-group">
                                <label for="targetClassSelect">수강반 선택</label>
                                <select id="targetClassSelect" class="form-control">
                                    <option value="">수강반을 선택하세요</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="studentManager.closeAddToClassModal()">
                                취소
                            </button>
                            <button type="button" class="btn btn-primary" onclick="studentManager.addSelectedToClass()">
                                등록
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 수강반 관리 탭 -->
            <section id="class-management" class="tab-content">
                <div class="section-header">
                    <h2>수강반 관리</h2>
                    <button id="createClassBtn" class="btn btn-primary" onclick="classManager.showCreateClassModal()">새 수강반 만들기</button>
                </div>

                <!-- 필터 영역 -->
                <div class="class-filter-bar">
                    <div class="filter-group" id="orgFilterGroup" style="display: none;">
                        <label>기관</label>
                        <select id="classOrgFilter" class="form-control" onchange="classManager.onOrgFilterChange()">
                            <option value="">전체 기관</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>검색</label>
                        <input type="text" id="classSearchInput" class="form-control"
                               placeholder="수강반 이름으로 검색..."
                               oninput="classManager.onSearchChange(this.value)">
                    </div>
                </div>

                <!-- 좌우 분할 레이아웃 -->
                <div class="class-management-layout">
                    <!-- 좌측: 수강반 리스트 -->
                    <div class="class-list-panel">
                        <div class="panel-header">
                            <span>수강반 목록</span>
                            <span id="classListCount" class="count-badge">0개</span>
                        </div>
                        <div id="classList" class="class-list-items">
                            <!-- 수강반 리스트가 동적으로 추가됨 -->
                        </div>
                        <div id="classPagination" class="pagination">
                            <!-- 페이지네이션 -->
                        </div>
                    </div>

                    <!-- 우측: 수강반 상세 및 학생 목록 -->
                    <div class="class-detail-panel" id="classDetailPanel">
                        <div class="panel-placeholder" id="classDetailPlaceholder">
                            <p>좌측에서 수강반을 선택하세요</p>
                        </div>
                        <div id="classDetailContent" style="display: none;">
                            <div class="detail-header">
                                <div class="detail-title-row">
                                    <h3 id="classDetailTitle">수강반명</h3>
                                    <div class="detail-actions">
                                        <button class="btn btn-sm btn-secondary" onclick="classManager.showEditClassModal()">수정</button>
                                        <button class="btn btn-sm btn-danger" onclick="classManager.deleteSelectedClass()">삭제</button>
                                    </div>
                                </div>
                                <p id="classDetailInfo" class="detail-info"></p>
                            </div>
                            <div class="class-students-section">
                                <div class="students-header">
                                    <h4>소속 학생 (<span id="classStudentCount">0</span>명)</h4>
                                    <button class="btn btn-secondary btn-sm" onclick="classManager.showAddStudentModal()">
                                        학생 추가
                                    </button>
                                </div>
                                <div id="classStudentList" class="class-student-list">
                                    <!-- 학생 목록이 동적으로 추가됨 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 답안 입력 탭 -->
            <section id="answer-input" class="tab-content">
                <div class="section-header">
                    <h2>답안 입력</h2>
                </div>

                <div class="answer-input-controls">
                    <div class="form-group">
                        <label>시험 선택</label>
                        <div class="searchable-select" id="answerExamSelectWrapper">
                            <select id="answerExamSelect" class="form-control">
                                <option value="">시험을 선택하세요</option>
                            </select>
                        </div>
                    </div>

                    <div class="answer-toolbar">
                        <button id="selectStudentBtn" class="btn btn-primary">답안 입력 시작</button>
                        <button id="importAnswersBtn" class="btn btn-secondary">답안 CSV 일괄 업로드</button>
                        <button id="exportAnswersBtn" class="btn btn-secondary">답안 CSV 내보내기</button>
                    </div>
                </div>

                <div id="answerFormSection" class="answer-form-section" style="display: none;">
                    <div id="answerFormContainer" class="answer-form-container">
                        <!-- 답안 입력 시트가 여기에 동적으로 생성됨 -->
                    </div>
                </div>
            </section>

            <!-- 채점 및 분석 탭 -->
            <section id="grading" class="tab-content">
                <div class="section-header">
                    <h2>채점 및 분석</h2>
                </div>

                <div class="grading-controls">
                    <div class="form-group">
                        <label>시험 선택</label>
                        <div class="searchable-select" id="gradingExamSelectWrapper">
                            <select id="gradingExamSelect" class="form-control">
                                <option value="">시험을 선택하세요</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="gradingResultsSection" class="grading-results-section" style="display: none;">
                    <div class="grading-summary">
                        <h3>채점 현황</h3>
                        <div id="gradingSummary" class="summary-cards">
                            <!-- 요약 정보가 여기에 표시됨 -->
                        </div>
                    </div>

                    <div class="results-table-section">
                        <h3>학생별 성적</h3>
                        <button id="exportResultsBtn" class="btn btn-secondary">성적표 CSV 내보내기</button>
                        <div id="resultsTable" class="results-table">
                            <!-- 성적표 테이블이 여기에 표시됨 -->
                        </div>
                    </div>

                    <div class="question-analysis-section">
                        <h3>문제별 분석</h3>
                        <div id="questionAnalysis" class="question-analysis">
                            <!-- 문제별 분석이 여기에 표시됨 -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- 성적표 생성 탭 -->
            <section id="report" class="tab-content">
                <div class="section-header">
                    <h2>성적표 생성</h2>
                </div>

                <div class="report-controls">
                    <div class="form-group">
                        <label>시험 선택</label>
                        <div class="searchable-select" id="reportExamSelectWrapper">
                            <select id="reportExamSelect" class="form-control">
                                <option value="">시험을 선택하세요</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>학생 선택</label>
                        <div class="searchable-select" id="reportStudentSelectWrapper">
                            <select id="reportStudentSelect" class="form-control">
                                <option value="">학생을 선택하세요</option>
                            </select>
                        </div>
                    </div>

                    <div class="report-actions">
                        <button id="generateReportBtn" class="btn btn-primary">성적표 생성</button>
                        <button id="printReportBtn" class="btn btn-secondary">인쇄</button>
                        <button id="exportPdfBtn" class="btn btn-secondary">PDF 저장</button>
                    </div>
                </div>

                <div id="reportPreview" class="report-preview">
                    <!-- 성적표 미리보기가 여기에 표시됨 -->
                </div>
            </section>

            <!-- 학생별 오답 노트 탭 -->
            <section id="wrong-note" class="tab-content">
                <div class="section-header">
                    <h2>학생별 오답 노트</h2>
                </div>

                <div class="wrong-note-controls">
                    <div class="form-group">
                        <label>학생 선택</label>
                        <div class="searchable-select" id="wrongNoteStudentSelectWrapper">
                            <select id="wrongNoteStudentSelect" class="form-control">
                                <option value="">학생을 선택하세요</option>
                            </select>
                        </div>
                    </div>

                    <div id="wrongNoteExamSelection" class="exam-selection-section" style="display: none;">
                        <div class="form-group">
                            <div class="form-group-header">
                                <label>시험 선택 (복수 선택 가능)</label>
                                <button id="selectAllExamsBtn" class="btn btn-sm btn-secondary">모두 선택</button>
                            </div>
                            <div id="wrongNoteExamList" class="exam-checkbox-list">
                                <!-- 시험 체크박스 목록이 여기에 표시됨 -->
                            </div>
                        </div>

                        <div class="wrong-note-actions">
                            <button id="generateWrongNoteBtn" class="btn btn-primary">오답 노트 생성</button>
                            <button id="printWrongNoteBtn" class="btn btn-secondary">인쇄</button>
                            <button id="exportWrongNotePdfBtn" class="btn btn-secondary">PDF 저장</button>
                        </div>
                    </div>
                </div>

                <div id="wrongNoteResultsSection" class="wrong-note-results-section" style="display: none;">
                    <div class="wrong-note-summary">
                        <h3>학습 통계</h3>
                        <div id="wrongNoteSummary" class="summary-cards">
                            <!-- 요약 정보가 여기에 표시됨 -->
                        </div>
                    </div>

                    <div class="charts-section">
                        <div class="trend-chart-section">
                            <h3>성적 추이</h3>
                            <div class="trend-chart">
                                <canvas id="wrongNoteTrendChart" width="800" height="320"></canvas>
                            </div>
                        </div>

                        <div class="domain-stats-section">
                            <h3>영역별 정답률</h3>
                            <div class="domain-chart">
                                <canvas id="wrongNoteDomainChart" width="400" height="400"></canvas>
                            </div>
                        </div>

                        <div class="passage-stats-section">
                            <h3>단원/지문별 통계</h3>
                            <div id="wrongNotePassageStats" class="passage-stats-container">
                                <!-- 단원/지문별 통계가 여기에 표시됨 -->
                            </div>
                        </div>
                    </div>

                    <div id="wrongNotePreview" class="wrong-note-preview">
                        <!-- 오답 노트가 여기에 표시됨 -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 모달: 문제 추가/편집 -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="questionModalTitle">문제 추가</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>문항 번호</label>
                    <input type="number" id="questionNumber" class="form-control" min="1">
                </div>
                <div class="form-group">
                    <label>문제 유형</label>
                    <select id="questionType" class="form-control">
                        <option value="객관식">객관식</option>
                        <option value="서술형">서술형</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>영역 (대분류)</label>
                    <input type="text" id="questionDomain" class="form-control" placeholder="예: 문학, 독서, 문법">
                </div>
                <div class="form-group">
                    <label>세부 영역 (소분류)</label>
                    <input type="text" id="questionSubDomain" class="form-control" placeholder="예: 고전 시가, 현대 소설">
                </div>
                <div class="form-group">
                    <label>작품/지문/단원</label>
                    <input type="text" id="questionPassage" class="form-control">
                </div>
                <div class="form-group">
                    <label>배점</label>
                    <input type="number" id="questionPoints" class="form-control" step="0.1" min="0">
                </div>
                <div class="form-group">
                    <label>출제 의도</label>
                    <textarea id="questionIntent" class="form-control" rows="3"></textarea>
                </div>
                <div id="multipleChoiceFields" class="multiple-choice-fields">
                    <div class="form-group">
                        <label>정답 (선택지 번호)</label>
                        <input type="number" id="questionCorrectAnswer" class="form-control" min="1" max="5">
                    </div>
                    <div id="choicesContainer">
                        <!-- 선택지 입력 필드들 -->
                    </div>
                    <button id="addChoiceBtn" class="btn btn-secondary btn-sm">선택지 추가</button>
                </div>
                <div id="essayFields" class="essay-fields" style="display: none;">
                    <div class="form-group">
                        <label>모범 답안</label>
                        <textarea id="questionModelAnswer" class="form-control" rows="4"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveQuestionBtn" class="btn btn-primary">저장</button>
                <button id="cancelQuestionBtn" class="btn btn-secondary">취소</button>
            </div>
        </div>
    </div>

    <!-- 파일 입력 (숨김) -->
    <input type="file" id="fileInput" accept=".csv" style="display: none;">
    <input type="file" id="backupInput" accept=".json" style="display: none;">

    <!-- 문제 분석 모달 -->
    <div id="questionAnalysisModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 id="modalQuestionTitle">문제 분석</h3>
                <button class="modal-close" onclick="grading.closeQuestionModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalQuestionBody">
                <!-- 문제 상세 분석이 여기에 표시됨 -->
            </div>
        </div>
    </div>

    <!-- 학생 목록 모달 -->
    <div id="studentListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="studentListModalTitle">학생 목록</h3>
                <button class="modal-close" onclick="grading.closeStudentListModal()">&times;</button>
            </div>
            <div class="modal-body" id="studentListModalBody">
                <!-- 학생 목록이 여기에 표시됨 -->
            </div>
        </div>
    </div>

    <!-- 학생 정보 수정 모달 -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>학생 정보 수정</h3>
                <button class="modal-close" id="closeEditStudentModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" id="editStudentName" class="form-control" placeholder="학생 이름">
                </div>
                <div class="form-group">
                    <label>학교</label>
                    <input type="text" id="editStudentSchool" class="form-control" placeholder="학교명">
                </div>
                <div class="form-group">
                    <label>학년</label>
                    <input type="text" id="editStudentGrade" class="form-control" placeholder="예: 1학년, 2학년">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditStudentBtn">취소</button>
                <button class="btn btn-primary" id="saveEditStudentBtn">저장</button>
            </div>
        </div>
    </div>

    <!-- 비밀번호 변경 모달 -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>비밀번호 변경</h3>
                <button class="modal-close" id="closeChangePasswordModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>현재 비밀번호</label>
                    <input type="password" id="currentPassword" class="form-control" placeholder="현재 비밀번호 입력">
                </div>
                <div class="form-group">
                    <label>새 비밀번호</label>
                    <input type="password" id="newPassword" class="form-control" placeholder="새 비밀번호 (4자 이상)">
                </div>
                <div class="form-group">
                    <label>새 비밀번호 확인</label>
                    <input type="password" id="confirmNewPassword" class="form-control" placeholder="새 비밀번호 다시 입력">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelChangePasswordBtn">취소</button>
                <button class="btn btn-primary" id="saveChangePasswordBtn">변경</button>
            </div>
        </div>
    </div>

    <!-- 외부 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- AWS Cognito SDK -->
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6/dist/amazon-cognito-identity.min.js"></script>

    <!-- 애플리케이션 스크립트 -->
    <script src="js/config.js?v=20250103b"></script>
    <script src="js/data-model.js?v=20250103b"></script>
    <script src="js/cognito-auth.js?v=20250103b"></script>
    <script src="js/api-client.js?v=20250103b"></script>
    <script src="js/auth-utils.js?v=20250103b"></script>
    <script src="js/session-manager.js?v=20250103b"></script>
    <script src="js/auth-service.js?v=20250103b"></script>
    <script src="js/admin-panel.js?v=20250103b"></script>
    <script src="js/student-account-manager.js?v=20250103b"></script>
    <script src="js/csv-utils.js?v=20250103b"></script>
    <script src="js/searchable-select.js?v=20250103b"></script>
    <script src="js/exam-manager.js?v=20250103b"></script>
    <script src="js/exam-manager-sheet.js?v=20250103b"></script>
    <script src="js/answer-input.js?v=20250103b"></script>
    <script src="js/answer-input-sheet.js?v=20250103b"></script>
    <script src="js/grading.js?v=20250103b"></script>
    <script src="js/report-generator.js?v=20250103b"></script>
    <script src="js/wrong-note.js?v=20250103b"></script>
    <script src="js/student-manager.js?v=20250103b"></script>
    <script src="js/auto-merge-students.js?v=20250103b"></script>
    <script src="js/class-manager.js?v=20250103b"></script>
    <script src="js/app.js?v=20250103b"></script>
</body>
</html>
